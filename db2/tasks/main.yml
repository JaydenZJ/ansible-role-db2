---
  - name: Disabling SELinux
    selinux: state=disabled
    tags: setup

  - name: Adding entry to /etc/hosts
    lineinfile:
      dest: /etc/hosts
      regexp: "^{{ ansible_default_ipv4.address }} {{ ansible_hostname }}$"
      line: "{{ ansible_default_ipv4.address }} {{ ansible_hostname }}"
    tags: setup

  - name: Downloading license key FTP da LB2
    get_url:
      url: ftp://transfer.lb2.com.br/downloads/connections/DB2_ESE_AUSI_QS_Activ_10.5.0.5.zip
      dest: /vagrant/db2_key.zip
    tags: download

  - name: Downloading DB2
    get_url:
      url: ftp://transfer.lb2.com.br/downloads/connections/DB2_Svr_10.5.0.3_Linux_x86-64.tar.gz
      dest: /vagrant/db2_10503.tar.gz
    tags: download

  - name: Installing OL Public repository
    get_url: 
      url: http://public-yum.oracle.com/public-yum-ol6.repo 
      dest: /etc/yum.repos.d/public-yum-release.repo
    tags: setup

  - name: Installing DB2 pre requisites packages
    yum: name={{item}} state=installed update_cache=yes disable_gpg_check=yes enablerepo=ol6_latest
    with_items: db2_packages
    tags: packages

  - name: Decompressing DB2 Server 10.5.3
    unarchive:
      src: /vagrant/db2_10503.tar.gz
      dest: /tmp/
      copy: no
      creates: /tmp/server
    tags: setup

  - name: Running DB2 Pre Requisits Check
    command: /tmp/server/db2prereqcheck -i -s
    register: precheck
    failed_when: "'failed' in precheck.stderr"
    changed_when: False 
    tags: setup

  - name: Creating DB2 groups
    group: name={{item}} state=present
    with_items:
      - db2iadm1
      - db2fadm1
    tags: setup

  # A senha criptografada Ã© oracle
  - name: Adding DB2 DB2INST1 user
    user: name=db2inst1 comment="DB2 Instance user" group=db2iadm1 uid=1004 password=ldUMKEu7/QCAY home=/home/db2inst1
    tags: setup

  - name: Adding DB2 DB2FENC1 user
    user: name=db2fenc1 comment="DB2 Fenced user" group=db2fadm1 uid=1003 password=ldUMKEu7/QCAY home=/home/db2fenc1
    tags: setup 

  - name: Installing DB2 10.5
    command: /tmp/server/db2setup -r /vagrant/db2/files/db2server.rsp
    args: 
      creates: /opt/ibm/db2/V10.5
    tags: install

  - name: Validating the current installation
    command: /opt/ibm/db2/V10.5/bin/db2val -o
    register: db2_val
    failed_when: "'DBI1335I' not in db2_val.stdout"
    changed_when: False
    tags: ['install', 'validate']